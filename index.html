<!DOCTYPE html>
<html lang="es">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <meta name="theme-color" content="#4caf50">
    <link rel="manifest" href="manifest.json">
  <title>Recordatorio de Medicamentos</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1>üíä Mis Medicamentos</h1>

  <div id="alerta" class="alert-box" aria-live="polite"></div>

  <section class="settings">
    <h2>‚öôÔ∏è Alertas</h2>
    <div class="notif-row">
      <button type="button" id="notifBtn">Activar notificaciones</button>
      <span id="notifStatus" aria-live="polite"></span>
    </div>
    <div class="push-row">
      <div class="push-actions">
        <button type="button" id="pushBtn">Activar recordatorios push</button>
        <span id="pushStatus" aria-live="polite"></span>
      </div>
      <label class="push-label">Suscripci√≥n (c√≥piala en tu servidor para enviar los avisos):
        <textarea id="pushData" readonly rows="4" placeholder="A√∫n no hay suscripci√≥n activa"></textarea>
      </label>
    </div>
    <label>
      N√∫mero WhatsApp (solo d√≠gitos):
      <input type="text" id="waNumber" inputmode="tel" pattern="[0-9]+" placeholder="56912345678">
    </label>
    <label class="inline">
      <input type="checkbox" id="waAuto"> Enviar alerta de umbral a WhatsApp autom√°ticamente
    </label>
    <small>Se abrir√° WhatsApp Web/m√≥vil con el mensaje prellenado al llegar al umbral.</small>
  </section>

  <form id="medForm">
    <input type="text" id="nombre" placeholder="Nombre del medicamento" required>
    <input type="number" id="stock" placeholder="Stock inicial" required>
    <input type="number" id="dosis" placeholder="Dosis diaria" required>
    <button type="submit">Agregar</button>
  </form>

  <ul id="listaMedicamentos"></ul>

  <h2>üìÖ Calendario de consumo</h2>
  <label>
  Ver calendario de:
  <select id="filtroMedicamento"></select>
    </label>

<div id="calendario"></div>

  <h2>üóÇÔ∏è Historial</h2>
  <div class="historial-filtros">
    <label>Medicamento:
      <select id="filtroHistMed"></select>
    </label>
    <label>Mes:
      <input type="month" id="filtroHistMes">
    </label>
  </div>
  <div id="historialLista"></div>

  <footer style="margin-top:20px; font-size:0.9rem;">
    <a href="privacy-policy.md" target="_blank">Pol√≠tica de Privacidad / Privacy Policy</a>
  </footer>


  <script>
    window.APP_CONFIG = window.APP_CONFIG || {};
  </script>
  <script src="config.js"></script>
  <script src="app.js"></script>
  <script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./firebase-messaging-sw.js");
}
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC97Y2EYed-MN_LfAlK_Xe4XBariy6ct1o",
    authDomain: "med-reminder-ab396.firebaseapp.com",
    projectId: "med-reminder-ab396",
    storageBucket: "med-reminder-ab396.firebasestorage.app",
    messagingSenderId: "916040866686",
    appId: "1:916040866686:web:c7cde5727063a02772312f"
  };

  const app = initializeApp(firebaseConfig);
  const messaging = getMessaging(app);

  async function initNotifications() {
    if (!("Notification" in window)) {
      console.log("Notificaciones no soportadas en este navegador");
      return;
    }

    const permission = await Notification.requestPermission();

    if (permission !== "granted") {
      console.log("Permiso de notificaci√≥n rechazado");
      return;
    }

    const swRegistration = await navigator.serviceWorker?.ready.catch(() => null);
    if (!swRegistration) {
      console.log("No se pudo acceder al Service Worker para FCM");
      return;
    }

    const token = await getToken(messaging, {
      vapidKey: "BKFNRtTEhfw0Q5j27w-3Lr7hDU3AG-cWxKv7NZqcrFtguRIMt268yIMsSft4mabJyAGrKET_WRlEntldbE_GM0A",
      serviceWorkerRegistration: swRegistration
    });

    console.log("FCM token:", token);
  }

  initNotifications();

</script>

</body>
</html>
